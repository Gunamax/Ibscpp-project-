<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root { --primary: #0984e3; --success: #00b894; --danger: #d63031; --warn: #e17055; --text: #2d3436; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            padding: 50px 20px 20px 20px; 
            color: var(--text); 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            overflow-x: hidden; 
        }
        
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1506521781263-d8422e82f27a?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover; background-position: center; z-index: -1;
        }

        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .menu-btn { font-size: 28px; border: none; background: none; cursor: pointer; color: #fff; filter: drop-shadow(2px 2px 2px #000); }
        .app-title { font-weight: 700; font-size: 1.8em; color: #fff; text-shadow: 2px 2px 4px #000; letter-spacing: 1px; margin: 0;}
        
        .live-clock {
            color: #fff; font-size: 1.2em; font-weight: 600; margin-bottom: 25px;
            text-shadow: 1px 1px 3px #000; background: rgba(0,0,0,0.5);
            padding: 8px 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .admin-only { display: none; } 

        .bill-card {
            background: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba;
            text-align: center; margin-bottom: 20px; width: 100%; max-width: 400px; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: popIn 0.3s ease-out;
            position: fixed; top: 20%; z-index: 2500; 
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; padding-bottom: 20px; }
        
        .slot-card { 
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid #eee;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .free { background: var(--success); }
        .occupied { background: var(--danger); }
        .reserved { background: var(--warn); }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1em; cursor: pointer; margin-top: 5px;
            color: white; letter-spacing: 0.5px; position: relative; overflow: hidden;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        .btn-book { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); } 
        .btn-cancel { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-disabled { background: #b2bec3; cursor: not-allowed; color: #636e72; } 

        /* Sidebar Design */
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; transition: 0.3s; z-index: 2000; box-shadow: 5px 0 20px rgba(0,0,0,0.2); }
        .sidebar.active { left: 0; } 
        .sidebar-header { padding: 20px; background: var(--primary); color: white; }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 600; color: #555; }
        .menu-back-btn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; margin-bottom: 10px; }

        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; 
            display: none; 
        }
        .overlay.active { display: block; } 

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
        .input-field { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="sidebarOverlay" class="overlay" onclick="toggleSidebar()"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="app-title">Smart Parking</div>
        <div id="statusBadge" style="color:white; font-size:12px;">Connecting...</div>
    </div>

    <div id="liveClock" class="live-clock">Loading...</div>

    <div id="lastBill" class="bill-card">
        <strong>ЁЯЕ┐я╕П Parking Bill</strong><br>
        <span id="billAmount" style="font-size: 1.5em; color: #d63031;">Rs. 0</span>
        <br><button class="btn" style="background:#555; margin-top:10px;" onclick="document.getElementById('lastBill').style.display='none'">Close</button>
    </div>

    <div class="grid" id="grid"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="menu-back-btn" onclick="toggleSidebar()"><i class="fas fa-arrow-left"></i> Back</button>
            <h2 id="userName" style="margin:0;">Guest</h2>
        </div>
        <div class="menu-item" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Refresh Page</div>
        <div class="menu-item" onclick="openModal('loginModal')"><i class="fas fa-sign-in-alt"></i> Login</div>
        <div class="menu-item admin-only" onclick="resetSystem()"><i class="fas fa-tools"></i> Reset All Slots</div>
    </div>

    <div id="loginModal" class="modal"><div class="modal-box">
        <h3>Secure Login</h3>
        <input id="emailInput" type="email" class="input-field" placeholder="Enter Email">
        <input id="passInput" type="password" class="input-field" placeholder="Password">
        <button class="btn btn-book" onclick="login()">Login</button>
        <button class="btn" onclick="closeModal('loginModal')" style="background:none; color:#888;">Cancel</button>
    </div></div>

    <script>
        // --- JavaScript Code ---

        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.toggle('active'); 
            ov.classList.toggle('active');
        }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; toggleSidebar(); }

        const ADMIN_EMAIL = "maxguna9566@gmail.com";
        const ADMIN_PASS = "63803021"; 

        const MQTT_HOST = "broker.hivemq.com";
        const MQTT_PORT = 8000; 
        const ROOT_TOPIC = "my_smart_parking_project_123"; 

        let isAdmin = false;

        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);

        function login() {
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passInput').value.trim();
            if(email === ADMIN_EMAIL && pass === ADMIN_PASS) {
                isAdmin = true;
                document.getElementById('userName').innerText = "Admin";
                alert("Welcome Admin! You have full control."); 
                showAdminFeatures(true);
                closeModal('loginModal');
                for(let i=1; i<=6; i++) { updateVisuals(i); }
            } else {
                alert("Incorrect Password!"); 
            }
        }

        function showAdminFeatures(show) { 
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = show ? 'block' : 'none'); 
        }

        const grid = document.getElementById('grid'); 
        let slotState = {};
        for(let i=1; i<=6; i++) {
            slotState[i] = { sensor: false, booked: false };
            grid.innerHTML += `<div class="slot-card"><div id="s${i}" class="slot-visual free">Slot ${i}<br><small>Free</small></div>
            <button id="btn${i}" class="btn btn-book" onclick="userBookAction(${i})">Book</button></div>`;
        }

        let client;
        try { 
            client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "WebClient-"+parseInt(Math.random()*10000)); 
            client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: false }); 
        } catch(e) { console.log("MQTT Error", e); }

        function onConnect() { 
            console.log("Connected to HiveMQ"); 
            document.getElementById('statusBadge').innerText = "Online ЁЯЯв";
            client.subscribe(ROOT_TOPIC + "/#"); 
        }

        function onFail(responseObject) {
            console.log("Connection Failed: " + responseObject.errorMessage);
            document.getElementById('statusBadge').innerText = "Offline ЁЯФ┤";
        }

        if(client) {
            client.onMessageArrived = function(message) {
                const topic = message.destinationName; 
                const payload = message.payloadString;
                
                if(topic.includes("/bill")) { 
                    document.getElementById('lastBill').style.display = 'block'; 
                    document.getElementById('billAmount').innerText = payload; 
                }

                if (topic.includes("/s") && !topic.includes("/bookings/")) {
                    const slotId = parseInt(topic.split("/").pop().replace("s", ""));
                    if(slotId >= 1 && slotId <= 6) {
                        slotState[slotId].sensor = (payload === "true"); 
                        updateVisuals(slotId);
                    }
                } 
                else if (topic.includes("/bookings/s")) {
                    const slotId = parseInt(topic.split("/").pop().replace("s", ""));
                    slotState[slotId].booked = (payload === "true"); 
                    updateVisuals(slotId);
                }
            };
        }

        function updateVisuals(i) {
            const el = document.getElementById('s'+i); const btn = document.getElementById('btn'+i); const state = slotState[i];
            
            // 1. роХро╛ро░рпН роЪрпЖройрпНроЪро╛ро░ро┐ро▓рпН роЗро░рпБроирпНродро╛ро▓рпН (Already Parked)
            if(state.sensor) { 
                el.className = "slot-visual occupied"; el.innerHTML = `Slot ${i}<br><small>Occupied</small>`; 
                btn.className = "btn btn-disabled"; btn.innerText = "IN USE"; btn.disabled = true; 
                btn.style.opacity = "0.5";
            }
            // 2. ропро╛ро░ро╛ро╡родрпБ рокрпБроХрпН роЪрпЖропрпНродро┐ро░рпБроирпНродро╛ро▓рпН (Booked State)
            else if(state.booked) { 
                el.className = "slot-visual reserved"; el.innerHTML = `Slot ${i}<br><small>Reserved</small>`; 
                
                // --- роЗроЩрпНроХрпЗ родро╛ройрпН Magic роироЯроХрпНроХро┐ро▒родрпБ ---
                // роЗроирпНрод ро╕рпНро▓ро╛роЯрпНроЯрпИ 'роиро╛ройрпН' родро╛ройрпН рокрпБроХрпН роЪрпЖропрпНродрпЗройро╛? (Local Storage Check)
                let isMyBooking = localStorage.getItem('my_booking_s' + i) === 'true';

                if(isAdmin) {
                    // роЕроЯрпНрооро┐ройрпН ропро╛ро░ро╛роХ роЗро░рпБроирпНродро╛ро▓рпБроорпН роХрпЗройрпНроЪро▓рпН роЪрпЖропрпНропро▓ро╛роорпН
                    btn.className = "btn btn-cancel"; btn.innerText = "CANCEL (Admin)"; btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.onclick = () => toggleBook(i, false); 
                } 
                else if (isMyBooking) {
                    // роиро╛ройрпН рокрпБроХрпН роЪрпЖропрпНродродрпИ роиро╛ройрпЗ роХрпЗройрпНроЪро▓рпН роЪрпЖропрпНропро▓ро╛роорпН
                    btn.className = "btn btn-cancel"; btn.innerText = "CANCEL MY BOOKING"; btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.onclick = () => toggleBook(i, false); 
                }
                else {
                    // ро╡рпЗро▒рпБ ропро╛ро░рпЛ рокрпБроХрпН роЪрпЖропрпНродрпБро│рпНро│ройро░рпН - родрпКроЯ роорпБроЯро┐ропро╛родрпБ
                    btn.className = "btn btn-disabled"; btn.innerText = "RESERVED"; btn.disabled = true;
                    btn.style.opacity = "0.7";
                }
            }
            // 3. роХро╛ро▓ро┐ропро╛роХ роЗро░рпБроирпНродро╛ро▓рпН
            else { 
                el.className = "slot-visual free"; el.innerHTML = `Slot ${i}<br><small>Free</small>`; 
                btn.className = "btn btn-book"; btn.innerText = "BOOK"; btn.disabled = false;
                btn.style.opacity = "1";
                btn.onclick = () => userBookAction(i); 
                
                // ро╕рпНро▓ро╛роЯрпН роХро╛ро▓ро┐ропро╛роХро┐ро╡ро┐роЯрпНроЯро╛ро▓рпН, роОройрпНройрпБроЯрпИроп рокрпБроХрпНроХро┐роЩрпН ро▓ро┐ро╕рпНроЯро┐ро▓рпН роЗро░рпБроирпНродрпБроорпН роирпАроХрпНроХро┐ро╡ро┐роЯ ро╡рпЗрогрпНроЯрпБроорпН
                localStorage.removeItem('my_booking_s' + i);
            }
        }

        function userBookAction(i) {
            // рокрпБроХрпН роЪрпЖропрпНропрпБроорпНрокрпЛродрпБ, "роЗродрпБ роОройрпНройрпБроЯрпИроп рокрпБроХрпНроХро┐роЩрпН" роОройрпНро▒рпБ роорпЖрооро░ро┐ропро┐ро▓рпН роЪрпЗрооро┐роХрпНроХро┐ро▒рпЛроорпН
            localStorage.setItem('my_booking_s' + i, 'true');
            toggleBook(i, true);
        }

        function toggleBook(i, shouldBook) { 
            if(!client || !client.isConnected()) { alert("Connection Lost!"); return; }
            
            // роХрпЗройрпНроЪро▓рпН роЪрпЖропрпНропрпБроорпНрокрпЛродрпБ роорпЖрооро░ро┐ропро┐ро▓рпН роЗро░рпБроирпНродрпБ роирпАроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН
            if(!shouldBook) {
                localStorage.removeItem('my_booking_s' + i);
            }

            let message = new Paho.MQTT.Message(shouldBook ? "true" : "false"); 
            message.destinationName = ROOT_TOPIC + "/bookings/s" + i; 
            message.retained = true; 
            client.send(message); 
        }

        function resetSystem() {
            if(!isAdmin) return;
            if(confirm("Are you sure you want to clear all bookings?")) {
                for(let i=1; i<=6; i++) {
                    toggleBook(i, false);
                }
            }
        }
    </script>
</body>
</html>
